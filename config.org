#+title: Literate Doom Emacs Configuration
#+PROPERTY: header-args:elisp :tangle config.el

* Boilerplate
#+begin_src elisp
;;; $DOOMDIR/config.el -*- lexical-binding: t; -*-
#+end_src

* Initial Setup

** Startup Optimizations
#+begin_src elisp
;; Maximum GC threshold during startup - prevent collections entirely
(setq gc-cons-threshold most-positive-fixnum
      gc-cons-percentage 1.0)

;; Restore GC after startup with an idle-timer for smoother operation
(add-hook 'emacs-startup-hook
          (lambda ()
            ;; Reasonable GC settings for normal use
            (setq gc-cons-threshold (* 256 1024 1024)  ; 256MB
                  gc-cons-percentage 0.1)
            ;; GC when idle (5 seconds of no input, and no minibuffer)
            (run-with-idle-timer
             5 t
             (lambda ()
               (unless (active-minibuffer-window)
                 (garbage-collect))))))

;; Reduce startup noise / layout jitter
(setq inhibit-compacting-font-caches t
      inhibit-startup-screen t
      initial-scratch-message nil
      frame-inhibit-implied-resize t)  ; also good on Wayland/XWayland

;; Keep use-package behavior close to Doom defaults
;; (optional micro-optimization)
(setq use-package-expand-minimally t)

;; Doom's incremental loading – slightly relaxed so it interferes less
(setq doom-incremental-idle-timer 10.0
      doom-incremental-first-idle-timer 5.0)
#+end_src

** Identity & Auth
#+begin_src elisp
;; Some functionality uses this to identify you, e.g. GPG configuration,
;; email clients, file templates and snippets.
(setq user-full-name "David Vogel"
      user-mail-address "dvogelca@proton.me")

(setq auth-sources '("~/.authinfo.gpg" "~/.authinfo")
      auth-source-cache-expiry nil) ; default is 7200 (2h)
#+end_src

** Keychain / SSH Agent
Using ssh keys for various servers/repos, easiest way to keep this persistent.

#+begin_src elisp
;; Set SSH_AUTH_SOCK from gpg-agent keychain (systemd user unit)
(setenv "SSH_AUTH_SOCK"
        (concat (or (getenv "XDG_RUNTIME_DIR")
                    (format "/run/user/%d" (user-uid)))
                "/gnupg/S.gpg-agent.ssh"))
#+end_src

** Fonts
I really like GeistMono as a replacement for SourceCode Pro. Alegreya is a great writing font.

#+begin_src elisp
(setq doom-font (font-spec :family "Hasklug Nerd Font Mono" :size 16)
      doom-variable-pitch-font (font-spec :family "Alegreya" :size 18)
      doom-big-font (font-spec :family "Hasklug Nerd Font Mono" :size 22))
#+end_src

** Theme & UI
#+begin_src elisp
(setq doom-theme 'modus-vivendi-tinted)

;; Maintain terminal transparency in Doom Emacs
(after! doom-themes
  (unless (display-graphic-p)
    (set-face-background 'default "undefined")))

;; Remove top frame bar in Emacs
(add-to-list 'default-frame-alist '(undecorated . t))

;; Modeline appearance
(setq doom-modeline-icon t
      doom-modeline-major-mode-icon t
      doom-modeline-lsp-icon t
      doom-modeline-major-mode-color-icon t)
#+end_src

** Frame Transparency
#+begin_src elisp
(set-frame-parameter (selected-frame) 'alpha '(96 . 97))
(add-to-list 'default-frame-alist '(alpha . (96 . 97)))
#+end_src

** Indenting
#+begin_src elisp
;; Aggressive indent can be nice but sometimes intrusive.
;; Uncomment if you want it globally in prog-mode.
;; (use-package! aggressive-indent
;;   :hook (prog-mode . aggressive-indent-mode))
#+end_src

** Cursor Blink
#+begin_src elisp
(blink-cursor-mode 1)
#+end_src

** Line Wrapping & Line Numbers
We set visual line wrapping and relative line numbers so motions are easier.

#+begin_src elisp
;; Line numbers: nil, t, or 'relative
(setq display-line-numbers-type 'relative)

;; Soft wrapping by default
(global-visual-line-mode t)
#+end_src

** Trash & Auto Saving
#+begin_src elisp
;; Send files to trash instead of fully deleting
(setq delete-by-moving-to-trash t)

;; Enable simple auto-save
(setq auto-save-default t)
#+end_src

** General Performance / System Tweaks
#+begin_src elisp
;; Increase amount of data Emacs reads from processes (LSP, etc.)
(setq read-process-output-max (* 4 1024 1024)) ; 4MB

;; Native compilation tweaks
(setq comp-deferred-compilation t
      comp-async-jobs-number 4) ; a bit gentler than 8 on Ryzen 3

;; VC: only handle Git for speed (especially with TRAMP)
(setq vc-handled-backends '(Git))

;; Pointer focus behavior
(setq focus-follows-mouse nil)
#+end_src

** Browser Integration
Using Zen Browser via generic browse-url.

#+begin_src elisp
;; Use a specific external browser
(setq browse-url-browser-function 'browse-url-generic
      browse-url-generic-program "zen-browser")  ; adjust if needed
#+end_src

** Which-Key Speed
#+begin_src elisp
(setq which-key-idle-delay 0.2)
#+end_src

* Completion Stack (Vertico / Orderless / Consult / Embark)

** Minibuffer Completion Defaults
#+begin_src elisp
;; Make completion case-insensitive where it makes sense
(setq read-file-name-completion-ignore-case t
      read-buffer-completion-ignore-case t
      completion-ignore-case t)

;; Use the familiar C-x C-f interface for directory completion in minibuffer
(map! :map minibuffer-mode-map
      :when (modulep! :completion vertico)
      "C-x C-f" #'find-file)
#+end_src

** Savehist (minibuffer history)
#+begin_src elisp
(use-package! savehist
  :config
  (setq savehist-file (concat doom-cache-dir "savehist")
        savehist-save-minibuffer-history t
        history-length 1000
        history-delete-duplicates t
        savehist-additional-variables
        '(search-ring
          regexp-search-ring
          extended-command-history))
  (savehist-mode 1))
#+end_src

** Vertico + Orderless
#+begin_src elisp
(after! vertico
  ;; Tidy file paths in minibuffer
  (add-hook 'rfn-eshadow-update-overlay-hook #'vertico-directory-tidy)

  (define-key vertico-map (kbd "DEL")   #'vertico-directory-delete-char)
  (define-key vertico-map (kbd "M-DEL") #'vertico-directory-delete-word)

  ;; Display / navigation tweaks
  (setq vertico-count 17
        vertico-cycle t
        vertico-resize t
        vertico-sort-function #'vertico-sort-history-alpha)

  (define-key vertico-map (kbd "C-j")   #'vertico-next)
  (define-key vertico-map (kbd "C-k")   #'vertico-previous)
  (define-key vertico-map (kbd "M-RET") #'vertico-exit-input)

  ;; History navigation
  (define-key vertico-map (kbd "M-p") #'vertico-previous-history)
  (define-key vertico-map (kbd "M-n") #'vertico-next-history)
  (define-key vertico-map (kbd "C-r") #'consult-history)

  ;; Orderless: flexible, fuzzy-ish matching
  (setq completion-styles '(orderless basic)
        completion-category-defaults nil
        completion-category-overrides
        '((file (styles basic partial-completion orderless))))

  (setq orderless-component-separator #'orderless-escapable-split-on-space
        orderless-matching-styles
        '(orderless-literal
          orderless-prefixes
          orderless-initialism
          orderless-flex
          orderless-regexp)))
#+end_src

** Vertico Repeat
#+begin_src elisp
(use-package! vertico-repeat
  :after vertico
  :config
  (add-hook 'minibuffer-setup-hook #'vertico-repeat-save)
  (map! :leader
        (:prefix "r"
         :desc "Repeat last Vertico session" "v" #'vertico-repeat)))
#+end_src

** Marginalia
#+begin_src elisp
(after! marginalia
  (setq marginalia-annotators
        '(marginalia-annotators-heavy
          marginalia-annotators-light
          nil)
        marginalia-max-relative-age 0
        marginalia-align 'right))
#+end_src

** Embark Keybindings
#+begin_src elisp
(map! :leader
      (:prefix ("k" . "embark")  ;; 'k' to avoid conflicts with other apps
       :desc "Embark act"     "a" #'embark-act
       :desc "Embark dwim"    "d" #'embark-dwim
       :desc "Embark collect" "c" #'embark-collect))
#+end_src

** Consult (Search / Jump, like Telescope)
#+begin_src elisp
(after! consult
  (setq consult-preview-key "M-."
        consult-ripgrep-args
        "rg --null --line-buffered --color=never --max-columns=1000 --path-separator / --smart-case --no-heading --with-filename --line-number --search-zip"
        consult-narrow-key "<"
        consult-line-numbers-widen t
        consult-async-min-input 2
        consult-async-refresh-delay 0.15
        consult-async-input-throttle 0.2
        consult-async-input-debounce 0.1)

  ;; More useful previews for various commands
  (consult-customize
   consult-theme
   consult-ripgrep
   consult-git-grep
   consult-grep
   consult-bookmark
   consult-recent-file
   consult-xref
   :preview-key '(:debounce 0.4 any)))
#+end_src

** Consult-Dir
#+begin_src elisp
(use-package! consult-dir
  :bind (("C-x C-d" . consult-dir)
         :map vertico-map
         ("C-x C-d" . consult-dir)
         ("C-x C-j" . consult-dir-jump-file)))

(map! :leader
      (:prefix "s"
       :desc "Consult command history" "h" #'consult-history
       :desc "Consult recent directories" "d" #'consult-dir))
#+end_src

* Company Configuration
#+begin_src elisp
;; NOTE: If you decide to go all-in on Corfu, you can safely remove this
;; entire block *and* the `company` module from :completion in init.el.

(after! company
  (setq company-minimum-prefix-length 2
        company-idle-delay 0.2
        company-show-quick-access t
        company-tooltip-limit 20
        company-tooltip-align-annotations t)

  ;; Make company-files a higher priority backend
  (setq company-backends (cons 'company-files
                               (delete 'company-files company-backends)))

  ;; Better file path completion settings
  (setq company-files-exclusions nil
        company-files-chop-trailing-slash t)

  ;; Enable completion at point for file paths
  (defun my/enable-path-completion ()
    "Enable file path completion using company-files."
    (setq-local company-backends
                (cons 'company-files company-backends)))

  ;; Enable for all major modes
  (add-hook 'after-change-major-mode-hook #'my/enable-path-completion)

  ;; Heuristic: detect path-like input for a custom backend
  (defun my/looks-like-path-p (input)
    "Check if INPUT looks like a file path."
    (or (string-match-p "^/" input)       ;; Absolute path
        (string-match-p "^~/" input)      ;; Home directory
        (string-match-p "^\\.\\{1,2\\}/" input))) ;; ./ or ../ relative path

  (defun my/company-path-trigger (command &optional arg &rest ignored)
    "Company backend that triggers file completion for path-like input."
    (interactive (list 'interactive))
    (cl-case command
      (interactive (company-begin-backend 'company-files))
      (prefix (when (my/looks-like-path-p
                     (or (company-grab-line "\\([^ ]*\\)" 1) ""))
                (company-files 'prefix)))
      (t (apply #'company-files command arg ignored))))

  ;; Add the custom path trigger to backends
  (add-to-list 'company-backends 'my/company-path-trigger))
#+end_src
* Org Mode
#+begin_src elisp
(setq org-directory "~/org/"
      org-agenda-files '("~/org/todo.org" "~/org/agenda.org")  ; add more later if needed
      org-default-notes-file "~/org/inbox.org"

      ;; Org-roam basic setup
      org-roam-directory "~/org/notes"
      org-roam-capture-templates
      '(("d" "default" plain
         "%?"
         :if-new (file+head "%<%Y%m%d%H%M%S>-${slug}.org" "#+title: ${title}\n")
         :unnarrowed t)))

;; Keybindings — muscle memory heaven
(map! :leader
      :prefix ("v" . "workflow")
      :desc "Agenda"              "a" #'org-agenda
      :desc "Capture note/todo"   "c" #'org-capture
      :desc "Roam find"           "f" #'org-roam-node-find
      :desc "Roam capture"        "i" #'org-roam-capture
      :desc "Refile"              "r" #'org-refile
      :desc "Inbox - review"      "I" (lambda () (interactive) (find-file "~/org/inbox.org"))
      :desc "Daily review"        "d" #'my/daily-review)

#+end_src
** Capture Templates
#+begin_src elisp
(setq org-capture-templates
      '(("t" "Todo" entry
         (file "~/org/inbox.org")
         "* TODO %?\n  %i\n  %a" :empty-lines 1)

        ("n" "Note" entry
         (file "~/org/inbox.org")
         "* %? :note:\n  %i\n  %U" :empty-lines 1)

        ("m" "Meeting" entry
         (file "~/org/inbox.org")
         "* MEETING %? :meeting:\n  %U" :empty-lines 1)

        ("r" "Roam note" plain
         #'org-roam-capture--capture   ; the function
         "%?"
         :target (file+head "%<%Y%m%d%H%M%S>-${slug}.org"
                            "#+title: ${title}\n")
         :immediate-finish t
         :unnarrowed t)))
#+end_src

** Refiling setup
#+begin_src elisp
(setq org-refile-targets '(("~/org/todo.org" :maxlevel . 2)
                           ("~/org/agenda.org" :maxlevel . 2)
                           (org-agenda-files :maxlevel . 2)
                           ("~/org/notes" :maxlevel . 2)))  ; allows refiling to roam nodes too

(setq org-refile-use-outline-path 'file   ; shows filenames in refile menu
      org-outline-path-complete-in-steps nil)

#+end_src
** Todo keywords
#+begin_src elisp
(setq org-todo-keywords
      '((sequence "TODO(t)" "NEXT(n)" "WAITING(w)" "|" "DONE(d)" "CANCELLED(c)")))
#+end_src
** One-Key daily agenda + inbox review
#+begin_src elisp
(defun my/daily-review ()
  (interactive)
  (org-agenda nil "n")      ; custom agenda view showing inbox + today
  (delete-other-windows)
  (split-window-right)
  (find-file "~/org/inbox.org"))

(map! :leader :desc "Daily review" "o d" #'my/daily-review)

#+end_src
